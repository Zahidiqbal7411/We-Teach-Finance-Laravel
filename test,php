<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transactions Table with Export</title>
    <!-- Bootstrap CSS (for styling and modal) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome (for icons) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Required Libraries for Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Bootstrap JS (for modal functionality) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
    <div class="container mt-4">
        <h2>Transactions</h2>
        <!-- Buttons -->
        <div class="mb-3">
            <button id="exportPdfBtn" class="btn btn-outline-danger btn-sm">
                <i class="fa-solid fa-file-export me-1"></i> Export PDF
            </button>
            <button id="exportExcelBtn" class="btn btn-outline-success btn-sm">
                <i class="fa-solid fa-file-export me-1"></i> Export Excel
            </button>
            <button id="columnsBtn" class="btn btn-outline-dark btn-sm">
                <i class="fa-solid fa-table-columns me-1"></i> Columns
            </button>
        </div>
        <!-- Table -->
        <table id="transactionsTable" class="table table-bordered">
            <thead id="transactionsTableHead">
                <tr>
                    <th>ID</th>
                    <th>Date/Time</th>
                    <th>Teacher</th>
                    <th>Course</th>
                    <th>Session</th>
                    <th>Student</th>
                    <th>Parent</th>
                    <th>Total</th>
                    <th>Paid</th>
                    <th>Remaining</th>
                    <th class="text-end">Actions</th>
                </tr>
            </thead>
            <tbody id="transactionsTableBody">
                <!-- Sample Data (replace with your dynamic data) -->
                <tr>
                    <td>1</td>
                    <td>2023-10-01 10:00 AM</td>
                    <td>John Doe</td>
                    <td>Math 101</td>
                    <td>Session 1</td>
                    <td>Jane Smith</td>
                    <td>Parent Name</td>
                    <td>100.00 (USD)</td>
                    <td>50.00 (USD)</td>
                    <td>50.00 (USD)</td>
                    <td class="text-end">Action</td>
                </tr>
                <tr>
                    <td>2</td>
                    <td>2023-10-02 11:00 AM</td>
                    <td>Jane Doe</td>
                    <td>Science 101</td>
                    <td>Session 2</td>
                    <td>John Smith</td>
                    <td>Parent Name</td>
                    <td>200.00 (USD)</td>
                    <td>150.00 (USD)</td>
                    <td>50.00 (USD)</td>
                    <td class="text-end">Action</td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Columns Selection Modal -->
    <div class="modal fade" id="columnsModal" tabindex="-1" aria-labelledby="columnsModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="columnsModalLabel">Select Columns to Display</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="columnsCheckboxes"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="applyColumnsBtn">Apply</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Script (Your Original Logic, Inline for Completeness) -->
    <script>
        // Your main script logic (simplified for demo; integrate your full code here)
        document.addEventListener("DOMContentLoaded", function() {
            const tableHead = document.getElementById('transactionsTableHead');
            const tableBody = document.getElementById('transactionsTableBody');

            // Simulate loading data (replace with your fetch calls)
            function loadSampleData() {
                // This is just sample; in your real app, use loadPlatformTransactions or similar
                console.log('Data loaded (sample)');
            }
            loadSampleData();
        });
    </script>

    <!-- Separate Export and Columns Script -->
    <script>
        // export-columns.js - Separate script for column selection and export functionality
        document.addEventListener("DOMContentLoaded", function() {
            const tableHead = document.getElementById('transactionsTableHead');
            const tableBody = document.getElementById('transactionsTableBody');
            const columnsModalEl = document.getElementById('columnsModal');
            const columnsModal = new bootstrap.Modal(columnsModalEl);
            const columnsCheckboxes = document.getElementById('columnsCheckboxes');
            const applyColumnsBtn = document.getElementById('applyColumnsBtn');

            let currentColumns = [];

            // Columns Button
            const columnsBtn = document.getElementById('columnsBtn');
            if (columnsBtn) {
                columnsBtn.addEventListener('click', function() {
                    console.log('Columns button clicked');
                    const headers = Array.from(tableHead.querySelectorAll('th')).map(th => th.textContent.trim());
                    columnsCheckboxes.innerHTML = '';
                    currentColumns = headers.map((header, index) => ({ header, index, visible: true }));

                    headers.forEach((header, index) => {
                        const checkbox = document.createElement('div');
                        checkbox.className = 'form-check';
                        checkbox.innerHTML = `
                            <input class="form-check-input" type="checkbox" id="col-${index}" checked>
                            <label class="form-check-label" for="col-${index}">${header}</label>
                        `;
                        columnsCheckboxes.appendChild(checkbox);
                    });

                    columnsModal.show();
                });
            } else {
                console.error('Columns button not found.');
            }

            // Apply Columns
            if (applyColumnsBtn) {
                applyColumnsBtn.addEventListener('click', function() {
                    const checkboxes = columnsCheckboxes.querySelectorAll('input[type="checkbox"]');
                    checkboxes.forEach((cb, index) => {
                        currentColumns[index].visible = cb.checked;
                    });
                    updateColumnVisibility();
                    columnsModal.hide();
                });
            }

            function updateColumnVisibility() {
                const rows = document.querySelectorAll('#transactionsTableBody tr, #transactionsTableHead tr');
                rows.forEach(row => {
                    const cells = row.querySelectorAll('td, th');
                    cells.forEach((cell, index) => {
                        cell.style.display = currentColumns[index]?.visible ? '' : 'none';
                    });
                });
            }

            // Export Excel
            const exportExcelBtn = document.getElementById('exportExcelBtn');
            if (exportExcelBtn) {
                exportExcelBtn.addEventListener('click', function() {
                    console.log('Export Excel clicked');
                    const table = document.getElementById('transactionsTable');
                    if (!table) return console.error('Table not found.');
                    const visibleColumns = currentColumns.filter(col => col.visible).map(col => col.index);
                    const data = [];

                    const headers = Array.from(tableHead.querySelectorAll('th')).filter((_, index) => visibleColumns.includes(index)).map(th => th.textContent.trim());
                    data.push(headers);

                    const bodyRows = tableBody.querySelectorAll('tr');
                    bodyRows.forEach(row => {
                        const cells = row.querySelectorAll('td');
                        const rowData = Array.from(cells).filter((_, index) => visibleColumns.includes(index)).map(cell => cell.textContent.trim());
                        data.push(rowData);
                    });

                    const ws = XLSX.utils.aoa_to_sheet(data);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, 'Transactions');
                    XLSX.writeFile(wb, 'Transactions_Test.xlsx');
                });
            } else {
                console.error('Export Excel button not found.');
            }

            // Export PDF
            const exportPdfBtn = document.getElementById('exportPdfBtn');
            if (exportPdfBtn) {
                exportPdfBtn.addEventListener('click', function() {
                    console.log('Export PDF clicked');
                    const table = document.getElementById('transactionsTable');
                    if (!table) return console.error('Table not found.');
                    html2canvas(table).then(canvas => {
                        const imgData = canvas.toDataURL('image/png');
                        const pdf = new jspdf.jsPDF();
                        const imgWidth = 210;
                        const pageHeight = 295;
                        const imgHeight = (canvas.height * imgWidth) / canvas.width;
                        let heightLeft = imgHeight;

                        let position = 0;
                        pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                        heightLeft -= pageHeight;

                        while (heightLeft >= 0) {
                            position = heightLeft - imgHeight;
                            pdf.addPage();
                            pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                            heightLeft -= pageHeight;
                        }

                        pdf.save('Transactions_Test.pdf');
                    }).catch(err => console.error('PDF export failed:', err));
                });
            } else {
                console.error('Export PDF button not found.');
            }
        });
    </script>
</body>
</html>
